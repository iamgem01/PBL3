_format_version: "3.0"
services:
# Note Service #
  - name: note-service
    host: note-service
    port: 8080
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        config: 
          origins: 
            - http://localhost:3000 #url of frontend
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Encoding  
            - Content-Type
            - Authorization
            - Origin
          # Ensure that frontend can't read cookie if options don't return the right header
          exposed_headers: 
            - Set-Cookie
          max_age: 3600
          # Cookie can be returned by backend
          # Cors fails when have credential
          preflight_continue: true
          credentials: true # accept httpOnly cookie 
    routes:
    - name: notes-resource
      paths:
        - /api/notes
      methods: [GET, POST, PUT, DELETE, PATCH, OPTIONS]
      strip_path: false
      preserve_host: false
      protocols: [http, https]
    - name: folders-resource
      paths: 
        - /api/folders
      methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
      strip_path: false
      preserve_host: false
      protocols: [http, https]
    
    - name: data-resource
      paths: 
        - /api/data
      methods: [GET, POST, OPTIONS]
      strip_path: false
      preserve_host: false
      protocols: [http, https]
    - name: trash-resource
      paths:
        - /api/trash
      methods: [GET, POST, DELETE, OPTIONS]
      strip_path: false
      preserve_host: false
      protocols: [http, https]
  # User Service 
  - name: user-service
    host: user-service
    port: 8082
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        config:
          origins: 
            - http://localhost:3000
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Encoding  
            - Content-Type
            - Authorization
            - Origin
          credentials: true
          exposed_headers:
            - Set-Cookie
          max_age: 3600
          preflight_continue: true
          credentials: true
    routes:
      - name: auth-resource
        paths: 
          - /oauth2/authorization/google
        methods: [GET, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]
      
      - name: login-resource
        paths: 
          - /login
        methods: [GET, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]
      - name: user-resource
        paths:
          - /api/users
          - /api/auth
        methods: [GET, POST, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]

    # AI Service #
  - name: ai-service
    host: ai-service
    port: 3001
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        config:
          origins:
            - http://localhost:3000
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Encoding
            - Content-Type
            - Authorization
            - Origin
          credentials: true
          exposed_headers:
            - Set-Cookie
          max_age: 3600
          preflight_continue: true
          credentials: true
    routes:
      - name: ai-resource
        paths:
          - /api/chat
        methods: [POST, GET, OPTIONS]
        strip_path: true
        preserve_host: false
        protocols: [http, https]


  - name: collab-service
    host: collab-service  
    port: 8084            
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        config: 
          origins: 
            - http://localhost:3000  
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Encoding  
            - Content-Type
            - Authorization
            - Origin
            - X-User-Id  
          exposed_headers: 
            - Set-Cookie
          max_age: 3600
          preflight_continue: true
          credentials: true
      - name: request-transformer  
        config:
          add:
            headers:
              - X-Forwarded-For:$remote_addr 
    routes:
      
      - name: collab-notes-shared
        paths:
          - /api/notes/shared
        methods: [GET, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]
      - name: collab-notes-share
        paths:
          - /api/notes/{noteId}/share  # Sử dụng regex nếu cần: /api/notes/(.*)/share
        methods: [POST, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]
      - name: collab-notes-unshare
        paths:
          - /api/notes/{noteId}/unshare
        methods: [POST, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]
      - name: collab-notes-detail
        paths:
          - /api/notes/{noteId}
        methods: [GET, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]
      - name: collab-invitations
        paths:
          - /api/invitations
        methods: [GET, POST, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]
      # Routes cho WebSocket (Yjs và STOMP/SockJS)
      - name: collab-ws-yjs
        paths:
          - /yjs-ws
        methods: [GET, OPTIONS]  # WebSocket upgrade từ GET
        strip_path: false
        protocols: [http, https]  # Kong sẽ tự upgrade thành ws/wss
      - name: collab-ws-stomp
        paths:
          - /ws-collab
        methods: [GET, OPTIONS]
        strip_path: false
        protocols: [http, https]
      - name: collab-health
        paths:
          - /health
        methods: [GET, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]

  - name: calendar-service
    host: calendar-service
    port: 5003
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins: 
      - name: cors
        config: 
          origins:
            - http://localhost:3000
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Encoding
            - Content-Type
            - Authorization
            - Origin 
            - X-User-Id
          exposed_headers:
            - Set-Cookie
          max_age: 3600
          preflight_continue: true
          credentials: true
    routes:
      - name: event-list
        paths:
          - /api/events
        methods: [GET, POST, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]
      - name: event-detail
        paths:
          - /api/events/{eventId}
        methods: [GET, PUT, DELETE, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]

      - name: calendar-upcoming
        paths: 
          - /api/events/upcoming
        methods: [GET, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]

  # Notification Service #
  - name: notification-service
    host: notification-service
    port: 5004
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        config:
          origins:
            - http://localhost:3000
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Encoding
            - Content-Type
            - Authorization
            - Origin
            - X-User-Id  
          exposed_headers:
            - Set-Cookie
          max_age: 3600
          preflight_continue: true
          credentials: true
    routes:
      - name: notification-resource
        paths:
          - /api/notifications
        methods: [GET, POST, PATCH, DELETE, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]

      
