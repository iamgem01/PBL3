_format_version: "3.0"
services:
# Note Service #
  - name: note-service
    host: note-service
    port: 8080
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        config: 
          origins: 
            - http://localhost:3000 #url of frontend
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Encoding  
            - Content-Type
            - Authorization
            - Origin
          # Ensure that frontend can't read cookie if options don't return the right header
          exposed_headers: 
            - Set-Cookie
          max_age: 3600
          # Cookie can be returned by backend
          # Cors fails when have credential
          preflight_continue: true
          credentials: true # accept httpOnly cookie 
    routes:
    - name: notes-resource
      paths:
        - /api/notes
      methods: [GET, POST, PUT, DELETE, PATCH, OPTIONS]
      strip_path: false
      preserve_host: false
      protocols: [http, https]
    - name: folders-resource
      paths: 
        - /api/folders
      methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]
      strip_path: false
      preserve_host: false
      protocols: [http, https]
    
    - name: data-resource
      paths: 
        - /api/data
      methods: [GET, POST, OPTIONS]
      strip_path: false
      preserve_host: false
      protocols: [http, https]
    - name: trash-resource
      paths:
        - /api/trash
      methods: [GET, POST, DELETE, OPTIONS]
      strip_path: false
      preserve_host: false
      protocols: [http, https]
  # User Service 
  - name: user-service
    host: user-service
    port: 8082
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        config:
          origins: 
            - http://localhost:3000
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Encoding  
            - Content-Type
            - Authorization
            - Origin
          credentials: true
          exposed_headers:
            - Set-Cookie
          max_age: 3600
          preflight_continue: true
          credentials: true
    routes:
      - name: auth-resource
        paths: 
          - /oauth2/authorization/google
        methods: [GET, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]
      
      - name: login-resource
        paths: 
          - /login
        methods: [GET, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]
      - name: user-resource
        paths:
          - /api/users
          - /api/auth
        methods: [GET, POST, OPTIONS]
        strip_path: false
        preserve_host: false
        protocols: [http, https]

    # AI Service #
  - name: ai-service
    host: ai-service
    port: 3001
    path: /api/chat
    protocol: http
    connect_timeout: 60000
    read_timeout: 60000
    write_timeout: 60000
    retries: 5
    plugins:
      - name: cors
        config:
          origins:
            - http://localhost:3000
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Accept-Encoding
            - Content-Type
            - Authorization
            - Origin
          credentials: true
          exposed_headers:
            - Set-Cookie
          max_age: 3600
          preflight_continue: true
          credentials: true
    routes:
      - name: ai-resource
        paths:
          - /api/ai
        methods: [POST, GET, OPTIONS]
        strip_path: true
        preserve_host: false
        protocols: [http, https]
      